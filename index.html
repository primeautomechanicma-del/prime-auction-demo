<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prime Motors Auction — Cadastro de carro</title>
  <style>
    body{margin:0;background:#0f1115;color:#eaeef5;font:16px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1120px;margin:24px auto;padding:0 16px}
    .card{background:#141823;border:1px solid #2a2f3a;border-radius:14px;box-shadow:0 12px 30px rgba(0,0,0,.22)}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 320px;min-width:260px}
    label{display:block;margin:12px 0 6px;color:#93a4bf}
    input,select{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #2a2f3a;background:#0f131c;color:#eaeef5}
    .btn{background:#1b73e8;border:0;color:#fff;padding:12px 16px;border-radius:10px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.alt{background:#2f3644}
    .title{padding:18px 18px 0;font-weight:700}
    .box{padding:18px}
    .muted{color:#8da2c6}
    .summary{min-height:120px}
    img#foto-carro{max-width:100%;border-radius:12px;margin-top:12px;display:none}
  </style>
  <!-- supabase-js (cdn) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <h2 style="margin:8px 0 18px;">Prime Motors Auction — <span class="muted">Cadastro de carro</span></h2>

    <div class="row">
      <!-- Formulário -->
      <div class="col card">
        <div class="title">Dados do veículo</div>
        <div class="box">
          <label>VIN</label>
          <div class="row" style="align-items:flex-end">
            <div class="col">
              <input id="vin" placeholder="Digite o VIN (17 caracteres)" />
            </div>
            <button class="btn" onclick="decodificarVIN()">Buscar pelo VIN</button>
          </div>

          <div class="row">
            <div class="col">
              <label>Quilometragem</label>
              <input id="km" placeholder="ex.: 58,500" />
            </div>
            <div class="col">
              <label>Título</label>
              <select id="titulo">
                <option value="Clean">Clean</option>
                <option value="Salvage">Salvage</option>
                <option value="Rebuilt">Rebuilt</option>
              </select>
            </div>
          </div>

          <label>Reserva (mínimo)</label>
          <input id="reserva" placeholder="ex.: 8,000" />

          <div style="margin-top:18px;display:flex;gap:8px">
            <button id="btn-save" class="btn">Salvar no Supabase</button>
            <button class="btn alt" onclick="limpar()">Limpar</button>
          </div>
        </div>
      </div>

      <!-- Resumo -->
      <div class="col card">
        <div class="title">Resumo</div>
        <div class="box summary">
          <div class="muted">Carro</div>
          <div id="resumo-carro" style="font-weight:700;margin-bottom:10px">—</div>

          <div class="muted">Foto</div>
          <img id="foto-carro" alt="Foto do carro" />
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Supabase config =====
    const SUPABASE_URL  = "https://jzijuaaqwtmmpuiljhuy.supabase.co";
    const SUPABASE_ANON = "PASTE_YOUR_SUPABASE_ANON_KEY_AQUI"; // <-- cole sua anon key aqui
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // helper
    const $ = sel => document.querySelector(sel);

    function setResumoCarro(txt){ const el = $('#resumo-carro'); if(el) el.textContent = txt || '—'; }
    function setFoto(url){
      const img = $('#foto-carro');
      if(!img) return;
      if(url){
        img.src = url;
        img.style.display = 'block';
        img.onerror = ()=>{ img.style.display='none'; };
      }else{
        img.style.display='none';
      }
    }
    function limpar(){
      $('#vin').value = '';
      $('#km').value = '';
      $('#reserva').value = '';
      $('#titulo').value = 'Clean';
      setResumoCarro('—'); setFoto(null);
      window.__decode__ = null;
    }

    // ===== VIN → chama Edge Function dynamic-action =====
    async function decodificarVIN(){
      const vin = $('#vin')?.value.trim().toUpperCase();
      if(!vin || vin.length!==17){ alert('VIN inválido (17 caracteres).'); return; }

      try{
        // chama sua função no Supabase
        const { data, error } = await supabase.functions.invoke('dynamic-action', {
          body: { vin }  // POST { vin }
        });
        if(error) throw error;

        const { year, make, model, trim, photoUrl } = data || {};
        const tituloCarro = [year, make, model, trim].filter(Boolean).join(' ');
        setResumoCarro(tituloCarro);
        setFoto(photoUrl);

        // guarda para salvar junto
        window.__decode__ = {
          year: year || null,
          make: make || null,
          model: model || null,
          trim: trim || null,
          photo_url: photoUrl || null
        };

      }catch(e){
        console.error(e);
        alert('Erro ao buscar VIN: ' + (e.message || e));
      }
    }

    // ===== Salvar no Supabase (tabela vehicles) =====
    async function salvarVeiculo(){
      try{
        const vin     = $('#vin')?.value.trim().toUpperCase();
        const km      = $('#km')?.value.trim();
        const titulo  = $('#titulo')?.value.trim();
        const reserva = $('#reserva')?.value.trim();

        if(!vin || vin.length!==17){
          alert('VIN inválido (17 caracteres).'); return;
        }

        // pega decode (se veio do VIN)
        const extra = window.__decode__ || {};
        const payload = {
          vin,
          mileage: km ? Number(String(km).replace(/[^\d]/g,'')) : null,
          title_brand: titulo || null,
          reserve: reserva ? Number(String(reserva).replace(/[^\d]/g,'')) : null,
          status: 'listed',
          year: extra.year ?? null,
          make: extra.make ?? null,
          model: extra.model ?? null,
          trim: extra.trim ?? null,
          photo_url: extra.photo_url ?? null
        };

        const { data, error } = await supabase.from('vehicles')
          .insert(payload)
          .select(); // retorna linha criada

        if(error) throw error;
        alert('✅ Veículo salvo! ID: ' + data[0].id);

      }catch(err){
        console.error(err);
        alert('Erro ao salvar: ' + (err.message || err));
      }
    }

    // liga botão salvar
    document.getElementById('btn-save')?.addEventListener('click', salvarVeiculo);
  </script>
</body>
</html>
